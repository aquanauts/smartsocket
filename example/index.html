<!DOCTYPE html>
<html lang="en">
  <head></head>
  <body>
    <h1>Smartsocket Example</h1>
    <hr>

    <template>
      <div class="MainView">
        <h4>Current State</h4>
        <table id='table' border="1">
          <thead>
          <tr>
            <th>Keys</th>
            <th>Values</th>
          </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
        <hr>
        <h4>Add State</h4>
        <form class="addForm">
          <label for="keyInput">Key:</label>
          <input id="keyInput" type="text">
          <label for="valueInput">Value: </label>
          <input id="valueInput" type="text">
          <button>Send</button>
        </form>
        <hr>
        <h4>Delete State</h4>
        <form class="deleteForm">
          <label for="deleteInput">Key:</label>
          <input id="deleteInput" type="text">
          <button>Delete</button>
        </form>
      </div>
    </template>

    <script type="module">
      import {createContext} from "/smartsocket.js";

      function mainView(context, viewParams) {
        const view = context.template('MainView')
        const tbody = view.querySelector('tbody');
        const socket = context.connect('ws');

        socket.onAdd((key, value) => {
          let row = tbody.querySelector('#' + msg.key);
          if (row === null) {
            row = document.createElement('tr');
            row.id = msg.key
            row.append(document.createElement('td'));
            row.append(document.createElement('td'));
            tbody.append(row);
          }
          row.childNodes[0].innerText = msg.key;
          row.childNodes[1].innerText = msg.value;
        })

        socket.onDelete((key) => {
          tbody.querySelector('#' + key).remove();
        })

        view.querySelector('.addForm').onsubmit = function () {
          ws.send(JSON.stringify({type:"a", key: window.keyInput.value, value: window.valueInput.value}));
          window.keyInput.value = ""
          window.valueInput.value = ""
          window.keyInput.focus()
          return false;
        }

        view.querySelector('.deleteForm').onsubmit = function () {
          ws.send(JSON.stringify({type:"d", key: window.deleteInput.value}));
          window.deleteInput.value = ""
          window.deleteInput.focus()
          return false;
        }
        return view;
      }

      createContext().startRouter({
        "": mainView,
        "#": mainView,
        "#main": mainView
      });
    </script>
  </body>
</html>
